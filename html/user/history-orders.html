<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lịch sử đơn hàng</title>
  <link rel="icon" type="image/png" href="https://minhviet.group/images/logo.png" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="../../css/style.css" />
  <link rel="stylesheet" href="../../css/nav.css" />
  <link rel="stylesheet" href="../../css/animation-add.css" />
</head>

<body style="background-color: #f5f5f5">
  <!-- <div id="menu_nav" style="z-index: 1"></div>
   -->
  <nav id="sidebar_navbar"></nav>

  <header id="template_header">
    <!-- <div class="container-fluid px-0" style="
            background-image: url('/img/imgheader.png');
            height: 500px;
            width: 100%;
          ">
        <div class="img-bottom" style="position: relative; bottom: -73%; width: 100%; z-index: 0;">
          <img class="w-100" src="https://marketplace.foodotawp.com/wp-content/themes/foodota/libs/images/wave.svg"
            alt="" style="opacity: 0.99;">
        </div>
        <div class="row justify-content-center text-center text-white algin-items-center">
          <div class="col-8" style="position: absolute; top: 15%">
            <div style="font-size: 6rem">Minh Việt Order Food</div>
            <br />
            <div style="font-size: 4rem">
              <span style="color: #ffcc00">Hỗ trợ:</span> 0398550111
            </div>
          </div>
        </div>
      </div> -->
  </header>
  <!-- <div class="container mt-5 historyOrdered">
      <div class="row my-3 justify-content-center">
        <table class="table col text-center">
          <thead>
            <tr>
              <th scope="col">Hoàn tác</th>
              <th scope="col">STT</th>
              <th scope="col">Ảnh món</th>
              <th scope="col">Tên món</th>
              <th scope="col">Số lượng</th>
              <th scope="col">Giá</th>
              <th scope="col">Thành tiền</th>
            </tr>
          </thead>
          <tbody id="list-order"></tbody>
        </table>
      </div>
    </div> -->
  <div class="mt-3 text-center" style="font-size: 35px; font-family: sans-serif; font-weight: bold">
    Lịch sử đơn hàng
  </div>
  <div class="container mt-5">
    <div class="row justify-content-center mt-3">
      <div id="list-order" class="col-8" style="
            box-shadow: rgba(17, 17, 26, 0.1) 0px 4px 16px,
              rgba(17, 17, 26, 0.1) 0px 8px 24px,
              rgba(17, 17, 26, 0.1) 0px 16px 56px;
          "></div>
    </div>
    <!-- <div class="row justify-content-center mt-3 " >
      <div class="card mb-3 col-7 p-0 border-0" style="box-shadow: rgba(17, 17, 26, 0.1) 0px 4px 16px, rgba(17, 17, 26, 0.1) 0px 8px 24px, rgba(17, 17, 26, 0.1) 0px 16px 56px;">
        <div class="row g-0 p-2" >
          <div class="col-md-2 my-auto">
            <img
              src="https://images.foody.vn/res/g87/865173/s750x750/e66259bb-3efd-4268-94cf-208bccd3-a754eeb5-221226162908.jpeg"
              class="img-fluid rounded-start " alt="..." />
          </div>
          <div class="col-md-10">
            <div class="card-body ms-3">
              <div class=" f-s-24 row card-title" style="font-family: sans-serif; font-weight: bold">
                Rau câu sữa dừa
              </div>
              <div class="row f-s-18 mb-2">Phụ phí tiền cốc, thìa</div>
              <div class="row">
                <div class="col-6 ps-0">Số lượng: 1</div>
                <div class="col-6" style="text-align: end;">Giá: 120000đ</div>
              </div>
            </div>
          </div>
        </div>
        <hr>

        <div class="row g-0 p-2" >
          <div class="col-md-2 my-auto">
            <img
              src="https://images.foody.vn/res/g87/865173/s750x750/e66259bb-3efd-4268-94cf-208bccd3-a754eeb5-221226162908.jpeg"
              class="img-fluid rounded-start " alt="..." />
          </div>
          <div class="col-md-10">
            <div class="card-body ms-3">
              <div class=" f-s-24 row card-title" style="font-family: sans-serif; font-weight: bold">
                Rau câu sữa dừa
              </div>
              <div class="row f-s-18 mb-2">Phụ phí tiền cốc, thìa</div>
              <div class="row">
                <div class="col-6 ps-0">Số lượng: 1</div>
                <div class="col-6" style="text-align: end;">Giá: 120000đ</div>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <div class="row">
            <div class="col-12 f-s-24" style="text-align: end;">Thành tiền: 25000đ</div>
          </div>
          <div class="row justify-content-center">
            <div class="col-2 btn btn-danger">Hoàn tác</div>
          </div>
        </div>
      </div>
    </div> -->
    <!-- <div class="row justify-content-center  mt-3">
      <div class="card mb-3 col-7 p-0 border-0 " style="box-shadow: rgba(17, 17, 26, 0.1) 0px 4px 16px, rgba(17, 17, 26, 0.1) 0px 8px 24px, rgba(17, 17, 26, 0.1) 0px 16px 56px;">
        <div class="row g-0 p-2" >
          <div class="col-md-2 my-auto">
            <img
              src="https://images.foody.vn/res/g87/865173/s750x750/e66259bb-3efd-4268-94cf-208bccd3-a754eeb5-221226162908.jpeg"
              class="img-fluid rounded-start" alt="..." />
          </div>
          <div class="col-md-10">
            <div class="card-body ms-3">
              <div class=" f-s-24 row card-title" style="font-family: sans-serif; font-weight: bold">
                Rau câu sữa dừa
              </div>
              <div class="row f-s-18 mb-2">Phụ phí tiền cốc, thìa</div>
              <div class="row">
                <div class="col-6 ps-0">Số lượng: 1</div>
                <div class="col-6" style="text-align: end;">Giá: 120000đ</div>
              </div>
            </div>
          </div>
        </div>
        <hr>
        <div class="card-footer">
          <div class="row">
            <div class="col-12 f-s-24" style="text-align: end;">Thành tiền: 25000đ</div>
          </div>
          <div class="row justify-content-center">
            <div class="col-2 btn btn-danger">Hoàn tác</div>
          </div>
        </div>
      </div>
    </div> -->
  </div>
</body>
<script src="../../fontawesome-6.2.0/js/all.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="../../jquery/jquery-3.6.1.min.js"></script>
<script src="../../js/GVs.js"></script>
<script>
  function renderHistoryOrders() {
    $.ajax({
      url: GVs.GETHISTORYORDERS,
      type: "GET",
      headers: {
        Authorization: `Bearer ${getCookie("token")}`,
      },
      success: (data) => {
        let html = "";
        if (data.length > 0) {
          data.list_order.forEach((elm1, i) => {
            var sum = 0;
            // html += `<tr>
            console.log(elm1);
            // <th rowspan=${elm1.dishes.length + 1
            //   } class="align-middle border-end" scope="row"><button class="btn btn-danger" onclick="deleteOrder('${elm1.id}')">Hoàn tác</button></th>`;
            //   console.log(elm1.id);
            elm1.dishes.forEach((elm2, index) => {
              sum += elm2.price * elm2.quantity;
              html += `
      <div class="card mb-3 col-12 p-0 border-0 mb-5" >
        <div class="row g-0 p-2" >
          <div class="col-md-2 my-auto">
            <img
              src="${elm2.photos}"
              class="img-fluid rounded-start" alt="..." />
          </div>
          <div class="col-md-10">
            <div class="card-body ms-3">
              <div class=" f-s-24 row card-title" style="font-family: sans-serif; font-weight: bold">
                ${elm2.name}
              </div>
              <div class="row f-s-18 mb-2">Phụ phí tiền cốc, thìa</div>
              <div class="row">
                <div class="col-6 ps-0">Số lượng:${elm2.quantity}</div>
                <div class="col-6" style="text-align: end;">Giá: ${formatNumber(
                elm2.price
              )}${elm2.unit}</div>
              </div>
            </div>
          </div>
        </div>
        <hr>
        </div>
      </div>
            `;
            });
            html += `
            <div class="card-footer">
          <div class="row">
            <div class="col-12 f-s-24" style="text-align: end;">Thành tiền: ${sum}</div>
          </div>
            <div class="row justify-content-center">
            <div class="col-sm-3 col-md-2 btn btn-danger mb-3 col-5" id= "undoOrder_${i}"  onclick="deleteOrder('${elm1.id}')" >Hoàn tác</div>
            <hr>
          </div>`;
          });
        } else {
          // html += `<td colspan="7">Lịch sử đơn hàng rỗng</td>`;
        }
        $("#list-order").html(html);
        // $("#history-orders-test").html(html);
        data.list_order.forEach((elm, index) => {
          if (
            new Date().toLocaleDateString("vi-VN") !=
            new Date(elm.createTime).toLocaleDateString("vi-VN")
          )
            $(`#undoOrder_${index}`).css("display", "none");
        });
        console.log(data);
      },
    });
  }
  renderHistoryOrders();

  function getCookie(cname) {
    let name = cname + "=";
    let decodedCookie = decodeURIComponent(document.cookie);
    let ca = decodedCookie.split(";");
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) == " ") {
        c = c.substring(1);
      }
      if (c.indexOf(name) == 0) {
        return c.substring(name.length, c.length);
      }
    }
    return "";
  }
  function deleteOrder(idOrder) {
    Swal.fire({
      title: "Bạn có chắc chắn muốn hoàn tác đơn hàng này không?",
      showDenyButton: true,
      confirmButtonText: "Có",
      denyButtonText: `Không`,
    }).then((result) => {
      /* Read more about isConfirmed, isDenied below */
      if (result.isConfirmed) {
        $.ajax({
          url: `${GVs.CANCELORDERS}/${idOrder}`,
          type: "DELETE",
          headers: {
            Authorization: `Bearer ${getCookie("token")}`,
          },
          success: (data) => {
            renderHistoryOrders();
            Swal.fire("Hoán tác thành công", "", "success");
            console.log("delete succes");
          },
        });
      }
    });

    //   console.log(idOrder);
  }
</script>
<script>
  function formatNumber(num) {
    return ("" + num).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, function ($1) {
      return $1 + ".";
    });
  }
</script>
<script src="../../js/nav.js"></script>

</html>